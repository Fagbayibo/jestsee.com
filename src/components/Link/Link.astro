---
interface Props extends astroHTML.JSX.AnchorHTMLAttributes {}

const { class: className, ...rest } = Astro.props
---

<a class:list={['custom-link', className]} {...rest}><slot /></a>

<script>
  function generateCustomEvent(path: string) {
    return new CustomEvent('local-navigation', {
      bubbles: true,
      detail: { path }
    })
  }

  function eventHandler(event: Event) {
    if (!event.currentTarget) return

    const href = (event.currentTarget as HTMLAnchorElement).href

    if (!href.startsWith(location.origin)) return

    const customEvent = generateCustomEvent(href.replace(location.origin, ''))

    event.currentTarget.dispatchEvent(customEvent)
  }

  document.addEventListener('astro:page-load', () => {
    const links = document.querySelectorAll('a.custom-link')
    links.forEach((link) => {
      link.addEventListener('click', eventHandler)
    })
  })

  window.addEventListener('popstate', () => {
    if (window.location.origin !== location.origin) return

    const customEvent = generateCustomEvent(window.location.pathname)

    document.dispatchEvent(customEvent)
  })
</script>
